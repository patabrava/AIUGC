{% extends "base.html" %}

{% block title %}Batches - FLOW-FORGE{% endblock %}

{% block content %}
<div
    x-data="batchListComponent()"
    data-batch-page
    x-init="init()"
    x-on:destroy="destroy()"
>
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-6">
        <div>
            <h2 class="text-2xl sm:text-3xl font-bold text-gray-900">Batches</h2>
            <p class="mt-1 text-sm text-gray-500">Manage your UGC video production batches</p>
        </div>
        <button 
            @click="showCreateModal = true"
            class="inline-flex items-center justify-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition sm:w-auto w-full"
        >
            <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
            New Batch
        </button>
    </div>

    <!-- Progress Banner -->
    <div
        x-show="Object.keys(batchProgress).length > 0"
        x-transition
        class="mb-4 rounded-lg border border-purple-200 bg-purple-50 p-4 text-sm text-purple-900"
    >
        <template x-for="(info, id) in batchProgress" :key="id">
            <div class="flex items-start justify-between gap-4">
                <div>
                    <p class="font-semibold" x-text="`Seeding batch: ${info.brand}`"></p>
                    <p class="mt-1 text-purple-800">
                        <span>Generating topics and postsâ€¦</span>
                        <template x-if="info.posts > 0">
                            <span x-text="` ${info.posts}/${info.expected} posts ready.`"></span>
                        </template>
                    </p>
                </div>
                <button 
                    type="button"
                    class="text-xs font-medium text-purple-700 hover:text-purple-900"
                    @click="removeProgressEntry(id)"
                >
                    Dismiss
                </button>
            </div>
        </template>
    </div>

    <!-- Filters -->
    <div class="mb-6 flex flex-wrap gap-2 sm:gap-4">
        <button 
            hx-get="/batches?archived=false" 
            hx-target="#batches-list"
            class="flex-1 sm:flex-none px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition"
        >
            Active
        </button>
        <button 
            hx-get="/batches?archived=true" 
            hx-target="#batches-list"
            class="flex-1 sm:flex-none px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition"
        >
            Archived
        </button>
        <button 
            hx-get="/batches" 
            hx-target="#batches-list"
            class="flex-1 sm:flex-none px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition"
        >
            All
        </button>
    </div>

    <!-- Batches List -->
    <div 
        id="batches-list"
        hx-get="/batches"
        hx-trigger="load"
        hx-target="#batches-list"
        hx-swap="innerHTML"
        hx-indicator="#list-loading"
        class="relative"
    >
        <div id="list-loading" class="htmx-indicator absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center z-10">
            <div class="text-center">
                <svg class="animate-spin h-8 w-8 text-purple-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-2 text-sm text-gray-600">Loading batches...</p>
            </div>
        </div>
        {% include "batches/partials/list_content.html" %}
    </div>

    <!-- Create Batch Modal -->
    <div 
        x-show="showCreateModal" 
        x-cloak
        class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50 px-4"
        @click.self="showCreateModal = false"
    >
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-4 sm:p-6 max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Create New Batch</h3>
            
            <form 
                hx-post="/batches" 
                hx-target="#batches-list"
                hx-indicator="#batch-spinner"
                @htmx:before-request="
                    const brand = $event.detail.elt.querySelector('[name=brand]').value;
                    const value = parseInt($event.detail.elt.querySelector('[name=\'post_type_counts.value\']').value) || 0;
                    const lifestyle = parseInt($event.detail.elt.querySelector('[name=\'post_type_counts.lifestyle\']').value) || 0;
                    const tempId = 'temp-' + Date.now();
                    window.dispatchEvent(new CustomEvent('batch-progress:update', {
                        detail: {
                            batchId: tempId,
                            brand,
                            expected: value + lifestyle,
                            posts: 0,
                            isTemp: true,
                        }
                    }));
                    console.log('Batch creation started:', brand);
                "
                @htmx:after-request="showCreateModal = false"
            >
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Batch Name</label>
                        <input 
                            type="text" 
                            name="brand" 
                            required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-purple-500 focus:border-purple-500"
                        >
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Post Type Counts</label>
                        <div class="space-y-2">
                            <div class="flex items-center justify-between">
                                <label class="text-sm text-gray-600">Value Posts</label>
                                <input 
                                    type="number" 
                                    name="post_type_counts.value" 
                                    min="0" 
                                    max="100" 
                                    value="3"
                                    class="w-20 border border-gray-300 rounded-md py-1 px-2 text-center"
                                >
                            </div>
                            <div class="flex items-center justify-between">
                                <label class="text-sm text-gray-600">Lifestyle Posts</label>
                                <input 
                                    type="number" 
                                    name="post_type_counts.lifestyle" 
                                    min="0" 
                                    max="100" 
                                    value="4"
                                    class="w-20 border border-gray-300 rounded-md py-1 px-2 text-center"
                                >
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end space-x-3">
                    <button 
                        type="button"
                        @click="showCreateModal = false"
                        class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50"
                    >
                        Cancel
                    </button>
                    <button 
                        type="submit"
                        class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-purple-600 hover:bg-purple-700 inline-flex items-center"
                    >
                        <span>Create Batch</span>
                        <svg id="batch-spinner" class="htmx-indicator ml-2 animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    [x-cloak] { display: none !important; }
    .htmx-indicator {
        display: none;
    }
    .htmx-request .htmx-indicator,
    .htmx-request.htmx-indicator {
        display: inline-block;
    }
</style>

<script>
    (function () {
        const POLL_INTERVAL_MS = 5000;
        const pollers = new Map();

        window.batchListComponent = function batchListComponent() {
            return {
                showCreateModal: false,
                batchProgress: {},
                cleanupHandlers: [],
                init() {
                    const updateHandler = (event) => {
                        const detail = event.detail || {};
                        const batchId = detail.batchId;
                        if (!batchId) {
                            return;
                        }

                        const brand = detail.brand;
                        const expected = detail.expected ?? 0;
                        const posts = detail.posts ?? 0;

                        const current = this.batchProgress || {};
                        const cleanedEntries = Object.entries(current).filter(([key, value]) => {
                            if (!value) {
                                return false;
                            }
                            if (!brand) {
                                return true;
                            }
                            const isTempEntry = key.startsWith('temp-');
                            return !(isTempEntry && value.brand === brand);
                        });
                        const cleaned = Object.fromEntries(cleanedEntries);

                        this.batchProgress = {
                            ...cleaned,
                            [batchId]: {
                                brand,
                                expected,
                                posts,
                            },
                        };
                    };

                    const clearHandler = (event) => {
                        const detail = event.detail || {};
                        const batchId = detail.batchId;

                        if (!batchId) {
                            this.batchProgress = {};
                            return;
                        }

                        const current = this.batchProgress || {};
                        if (!Object.prototype.hasOwnProperty.call(current, batchId)) {
                            return;
                        }

                        const { [batchId]: _removed, ...rest } = current;
                        this.batchProgress = rest;
                    };

                    window.addEventListener('batch-progress:update', updateHandler);
                    window.addEventListener('batch-progress:clear', clearHandler);

                    this.cleanupHandlers.push(() => {
                        window.removeEventListener('batch-progress:update', updateHandler);
                        window.removeEventListener('batch-progress:clear', clearHandler);
                    });
                },
                destroy() {
                    this.cleanupHandlers.forEach((dispose) => dispose());
                    this.cleanupHandlers = [];
                },
                removeProgressEntry(id) {
                    const current = this.batchProgress || {};
                    if (!Object.prototype.hasOwnProperty.call(current, id)) {
                        return;
                    }

                    const { [id]: _removed, ...rest } = current;
                    this.batchProgress = rest;
                },
            };
        };

        async function fetchStatus(batchId) {
            const response = await fetch(`/batches/${batchId}/status`, {
                headers: { "Accept": "application/json" },
            });

            if (!response.ok) {
                throw new Error(`Status fetch failed: ${response.status}`);
            }

            return response.json();
        }

        function refreshBatchList() {
            if (window.htmx) {
                window.htmx.ajax('GET', '/batches', {
                    target: '#batches-list',
                    swap: 'innerHTML',
                });
            } else {
                window.location.reload();
            }
        }

        function updateBanner(batchId, brand, expected, posts = 0) {
            window.dispatchEvent(new CustomEvent('batch-progress:update', {
                detail: {
                    batchId,
                    brand,
                    expected,
                    posts,
                }
            }));
        }

        function clearBanner(batchId) {
            window.dispatchEvent(new CustomEvent('batch-progress:clear', {
                detail: {
                    batchId,
                }
            }));
        }

        function startPolling(batchId, expectedPosts, brand) {
            if (pollers.has(batchId)) {
                return;
            }

            const poller = window.setInterval(async () => {
                try {
                    const payload = await fetchStatus(batchId);
                    if (!payload.ok) {
                        return;
                    }
                    const data = payload.data || {};
                    const postsReady = typeof expectedPosts === 'number' && data.posts_count >= expectedPosts;
                    const stateAdvanced = data.state && data.state !== 'S1_SETUP';

                    updateBanner(batchId, brand, expectedPosts, data.posts_count || 0);

                    if (postsReady || stateAdvanced) {
                        window.clearInterval(poller);
                        pollers.delete(batchId);
                        clearBanner(batchId);
                        refreshBatchList();
                    }
                } catch (error) {
                    console.error('Polling error for batch', batchId, error);
                }
            }, POLL_INTERVAL_MS);

            pollers.set(batchId, poller);
        }

        document.body.addEventListener('batch_created', (event) => {
            console.log('batch_created event received:', event.detail);
            const detail = event.detail || {};
            const batchId = detail.batch_id;
            const expectedPosts = detail.expected_posts;
            const brand = detail.brand || 'Unbenannte Marke';

            if (!batchId) {
                console.error('No batch_id in event detail');
                return;
            }

            console.log('Starting polling for batch:', batchId);
            updateBanner(batchId, brand, Number(expectedPosts), 0);
            startPolling(batchId, Number(expectedPosts), brand);
        });
        
        // Also listen on htmx:afterSwap to catch HX-Trigger events
        document.body.addEventListener('htmx:afterSwap', (event) => {
            console.log('htmx:afterSwap triggered');
            const triggerHeader = event.detail.xhr.getResponseHeader('HX-Trigger');
            if (triggerHeader) {
                console.log('HX-Trigger header found:', triggerHeader);
                try {
                    const triggers = JSON.parse(triggerHeader);
                    if (triggers.batch_created) {
                        console.log('Manually firing batch_created event');
                        const customEvent = new CustomEvent('batch_created', {
                            detail: triggers.batch_created
                        });
                        document.body.dispatchEvent(customEvent);
                    }
                } catch (e) {
                    console.error('Failed to parse HX-Trigger:', e);
                }
            }
        });
    })();
</script>
{% endblock %}
